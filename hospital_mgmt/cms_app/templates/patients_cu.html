{% extends 'includes/dash_base.html' %}

{% block internalStyles %}

{% endblock internalStyles %}

{% block mainContent %}

<main class="flex-1 bg-background-light dark:bg-background-dark">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-6 flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400">
            <a class="hover:text-primary" href="{% url 'patients_list' %}">Patients</a>
            <span class="material-symbols-outlined" style="font-size: 16px">chevron_right</span>
            <span class="font-medium text-slate-700 dark:text-slate-200">Create/Edit Patient</span>
        </div>
        <div class="flex flex-col lg:flex-row items-start gap-8">
            <div class="w-full lg:w-1/3 space-y-8">
                <div class="bg-card-light dark:bg-card-dark rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-4">Profile Photo</h3>
                    <div class="flex flex-col items-center">
                        <div
                            class="w-32 h-32 rounded-full bg-subtle-light dark:bg-subtle-dark flex items-center justify-center mb-4">
                            <span class="material-symbols-outlined text-5xl text-muted-light dark:text-muted-dark">
                                person </span>
                        </div>
                        <button
                            class="flex items-center justify-center gap-2 bg-primary/10 text-primary rounded-lg h-10 px-4 text-sm font-semibold hover:bg-primary/20 transition-colors">
                            <span class="material-symbols-outlined text-xl"> upload </span>
                            <span>Upload Photo</span>
                        </button>
                        <p class="text-xs text-muted-light dark:text-muted-dark mt-2">PNG, JPG, GIF up to
                            10MB</p>
                    </div>
                </div>
            </div>
            <div class="flex-1 bg-card-light dark:bg-card-dark rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold mb-6">Personal &amp; Contact Details</h3>
                <form id="patient-form" class="space-y-6">
                    {% csrf_token %}

                    <!-- Hidden input for edit mode -->
                    {% if patient %}
                    <input type="hidden" name="patient_id" value="{{ patient.user_id }}">
                    {% endif %}

                    <!-- Patient Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-muted-light dark:text-muted-dark mb-1"
                                for="full-name">Full Name</label>
                            <input name="full_name" value="{{ patient.name|default_if_none:'' }}"
                                class="w-full h-12 bg-background-light dark:bg-background-dark border border-subtle-light dark:border-subtle-dark rounded-lg px-4 focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                id="full-name" placeholder="Enter patient's full name" type="text" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-muted-light dark:text-muted-dark mb-1"
                                for="email">Email Address</label>
                            <input name="email" value="{{ patient.email_id|default_if_none:'' }}"
                                class="w-full h-12 bg-background-light dark:bg-background-dark border border-subtle-light dark:border-subtle-dark rounded-lg px-4 focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                id="email" placeholder="Enter email address" type="email" />
                        </div>
                    </div>

                    <!-- Age, Gender, Mobile -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-muted-light dark:text-muted-dark mb-1"
                                for="age">Age</label>
                            <input name="age" value="{{ patient.age|default_if_none:'' }}"
                                class="w-full h-12 bg-background-light dark:bg-background-dark border border-subtle-light dark:border-subtle-dark rounded-lg px-4 focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                id="age" placeholder="e.g. 34" type="number" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-muted-light dark:text-muted-dark mb-1"
                                for="gender">Gender</label>
                            <select name="gender"
                                class="w-full h-12 bg-background-light dark:bg-background-dark border border-subtle-light dark:border-subtle-dark rounded-lg px-4 focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                id="gender">
                                <option disabled {% if not patient %}selected{% endif %}>Select Gender</option>
                                {% for g in gender_choices %}
                                    <option value="{{ g }}"
                                        {% if patient and patient.gender|default:'' == g %} selected {% endif %}>
                                        {{ g }}
                                    </option>
                                {% endfor %}

                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-muted-light dark:text-muted-dark mb-1"
                                for="mobile-number">Mobile Number</label>
                            <input name="mobile_number" value="{{ patient.mobile_number|default_if_none:'' }}"
                                class="w-full h-12 bg-background-light dark:bg-background-dark border border-subtle-light dark:border-subtle-dark rounded-lg px-4 focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                id="mobile-number" placeholder="Enter mobile number" type="tel" />
                        </div>
                    </div>

                    <!-- Address -->
                    <div>
                        <label class="block text-sm font-medium text-muted-light dark:text-muted-dark mb-1"
                            for="address">Address</label>
                        <input name="address" value="{{ patient.patient_address|default_if_none:'' }}"
                            class="w-full h-12 bg-background-light dark:bg-background-dark border border-subtle-light dark:border-subtle-dark rounded-lg px-4 focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                            id="address" placeholder="Enter full address" type="text" />
                    </div>

                    <!-- Blood Group, Allergies, Medical History -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-muted-light dark:text-muted-dark mb-1"
                                for="blood-type">Blood Group</label>
                            <select name="blood_group"
                                class="w-full h-12 bg-background-light dark:bg-background-dark border border-subtle-light dark:border-subtle-dark rounded-lg px-4 focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                id="blood-type">
                                <option disabled {% if not patient %}selected{% endif %}>Select Blood Type</option>
                                {% for b in blood_group_choices %}
                                    <option value="{{ b }}"
                                        {% if patient and patient.blood_group|default:'' == b %} selected {% endif %}>
                                        {{ b }}
                                    </option>
                                {% endfor %}

                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-muted-light dark:text-muted-dark mb-1"
                                for="allergies">Allergies</label>
                            <textarea name="allergies"
                                class="w-full bg-background-light dark:bg-background-dark border border-subtle-light dark:border-subtle-dark rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                id="allergies" placeholder="e.g. Penicillin, Peanuts"
                                rows="3">{{ patient.allergies|default_if_none:'' }}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-muted-light dark:text-muted-dark mb-1"
                                for="medical-history">Medical History</label>
                            <textarea name="medical_history"
                                class="w-full bg-background-light dark:bg-background-dark border border-subtle-light dark:border-subtle-dark rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                id="medical-history" placeholder="e.g. Asthma, Hypertension"
                                rows="3">{{ patient.medical_history|default_if_none:'' }}</textarea>
                        </div>
                    </div>

                    <!-- Emergency Contact -->
                    <div class="border-t border-subtle-light dark:border-subtle-dark pt-6">
                        <h4 class="text-md font-semibold mb-4">Emergency Contact</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-muted-light dark:text-muted-dark mb-1"
                                    for="emergency-name">Full Name</label>
                                <input name="emergency_name" value="{{ patient.emergency_contact_name|default_if_none:'' }}"
                                    class="w-full h-12 bg-background-light dark:bg-background-dark border border-subtle-light dark:border-subtle-dark rounded-lg px-4 focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                    id="emergency-name" placeholder="Enter contact's name" type="text" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-muted-light dark:text-muted-dark mb-1"
                                    for="emergency-relation">Relationship</label>
                                <input name="emergency_relation"
                                    value="{{ patient.emergency_contact_relation|default_if_none:'' }}"
                                    class="w-full h-12 bg-background-light dark:bg-background-dark border border-subtle-light dark:border-subtle-dark rounded-lg px-4 focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                    id="emergency-relation" placeholder="e.g. Spouse, Parent" type="text" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-muted-light dark:text-muted-dark mb-1"
                                    for="emergency-mobile">Mobile Number</label>
                                <input name="emergency_mobile" value="{{ patient.emergency_contact_number|default_if_none:'' }}"
                                    class="w-full h-12 bg-background-light dark:bg-background-dark border border-subtle-light dark:border-subtle-dark rounded-lg px-4 focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                    id="emergency-mobile" placeholder="Enter contact's number" type="tel" />
                            </div>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="flex justify-end gap-4 pt-6">
                        <a href="{% url 'patients_list' %}" type="button"
                            class="flex items-center justify-center gap-2 bg-subtle-light dark:bg-subtle-dark text-foreground-light dark:text-foreground-dark rounded-lg h-10 px-5 text-sm font-semibold hover:bg-subtle-light/80 dark:hover:bg-subtle-dark/80 transition-colors">
                            <span>Cancel</span>
                        </a>
                        <button type="submit"
                            class="flex items-center justify-center gap-2 bg-primary text-white rounded-lg h-10 px-5 text-sm font-semibold hover:bg-primary/90 transition-colors shadow-sm">
                            <span class="material-symbols-outlined text-xl"> person_add </span>
                            <span>Save Patient</span>
                        </button>
                    </div>
                </form>

            </div>
        </div>
    </div>
</main>

{% endblock mainContent %}

{% block internalScripts %}
<script>
    document.getElementById("patient-form").addEventListener("submit", function (e) {
        e.preventDefault();

        const formData = new FormData(this);

        fetch("{% url 'save_patient' %}", {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            }
        })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                if (data.success) {
                    this.reset();
                    window.location.href = "{% url 'patients_list' %}";
                }
            })
            .catch(err => console.error(err));
    });
</script>

{% endblock internalScripts %}